name: Auto Add Resource

on:
  issues:
    types: [labeled]

jobs:
  add-resource:
    if: github.event.label.name == 'approved' && contains(github.event.issue.labels.*.name, '添加资源')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Issue and Create PR
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;

            function parseField(body, label) {
              const regex = new RegExp(`### ${label.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*\\n\\n([\\s\\S]*?)(?=\\n\\n###|$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            const name = parseField(body, '资源名称');
            const type = parseField(body, '资源类型');
            const description = parseField(body, '描述');
            const status = parseField(body, '当前状态');
            const owner = parseField(body, '负责人');
            const instructions = parseField(body, '使用说明') || '-';
            const link = parseField(body, '链接') || '-';

            if (!name) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '❌ 无法提取资源名称，请检查 Issue 格式。'
              });
              return;
            }

            const entry = `\n### ${name}\n- **资源类型**：${type}\n- **描述**：${description}\n- **当前状态**：${status}\n- **负责人**：${owner}\n- **使用说明**：${instructions}\n- **链接**：${link}\n`;

            // Create branch
            const branchName = `resource/add-${name.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fff]/g, '-')}`;
            const mainRef = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });

            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: mainRef.data.object.sha
              });
            } catch (e) {
              await github.rest.git.updateRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branchName}`,
                sha: mainRef.data.object.sha,
                force: true
              });
            }

            // Get current resources.md
            const file = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'data/resources.md',
              ref: branchName
            });

            const currentContent = Buffer.from(file.data.content, 'base64').toString('utf8');

            // Insert before "## 如何申请资源" section (under "## 资源列表")
            const marker = '\n---\n\n## 如何申请资源';
            let newContent;
            if (currentContent.includes(marker)) {
              newContent = currentContent.replace(marker, '\n' + entry + marker);
            } else {
              // Fallback: insert before first --- after 资源列表
              const fallbackMarker = /(\n---\n)/;
              const idx = currentContent.indexOf('## 资源列表');
              if (idx !== -1) {
                const afterList = currentContent.substring(idx);
                const dashMatch = afterList.match(/\n---\n/);
                if (dashMatch) {
                  const insertPos = idx + dashMatch.index;
                  newContent = currentContent.substring(0, insertPos) + '\n' + entry + currentContent.substring(insertPos);
                } else {
                  newContent = currentContent.trimEnd() + '\n' + entry;
                }
              } else {
                newContent = currentContent.trimEnd() + '\n' + entry;
              }
            }

            // Update file on branch
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'data/resources.md',
              message: `[资源] 添加 ${name} 到资源库`,
              content: Buffer.from(newContent).toString('base64'),
              sha: file.data.sha,
              branch: branchName
            });

            // Create PR
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[资源] 添加 ${name} 到资源库`,
              head: branchName,
              base: 'main',
              body: `## 变更类型\n- [x] 资源池变更\n\n## 变更内容\n自动添加新资源 **${name}** 到资源库。\n\n## 变更原因\n来自申请 Issue #${issue.number}，已通过审核。\n\n---\n*此 PR 由 GitHub Action 自动创建*`
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `✅ 已自动创建 PR #${pr.data.number}，合并后即完成入库。`
            });
