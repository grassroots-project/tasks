name: Sync Stats

on:
  issues:
    types: [labeled, unlabeled, assigned, unassigned]
  push:
    branches: [main]
    paths: ['data/people.md']

jobs:
  sync-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Rebuild stats tables
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Fetch all task issues (exclude äººæ‰åº“/èµ„æºæ± /ç”³è¯·åŠ å…¥)
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });

            const skipLabels = ['äººæ‰åº“', 'èµ„æºæ± ', 'ç”³è¯·åŠ å…¥', 'approved'];
            const tasks = issues.filter(i =>
              !i.pull_request &&
              !i.labels.some(l => skipLabels.includes(l.name))
            );

            // Read people.md
            let content = fs.readFileSync('data/people.md', 'utf8');

            // Parse members from content
            const memberBlocks = content.split(/(?=^### )/m).filter(b => b.startsWith('### '));
            const members = memberBlocks.map(block => {
              const nameMatch = block.match(/^### (.+)/);
              const currentMatch = block.match(/\*\*å½“å‰ä»»åŠ¡\*\*ï¼š(.+)/);
              const historyMatch = block.match(/\*\*å†å²è´¡çŒ®\*\*ï¼š(.+)/);
              return {
                name: nameMatch ? nameMatch[1].trim() : '',
                current: currentMatch ? currentMatch[1].trim() : '-',
                history: historyMatch ? historyMatch[1].trim() : '-'
              };
            });

            // Build æˆå‘˜ç»Ÿè®¡ table
            let memberTable = '| æˆå‘˜ | å½“å‰ä»»åŠ¡ | å†å²è´¡çŒ® |\n|------|---------|---------|';
            for (const m of members) {
              memberTable += `\n| ${m.name} | ${m.current} | ${m.history} |`;
            }

            // Build ä»»åŠ¡å‚ä¸æƒ…å†µ table
            const statusEmoji = { 'å¾…é¢†': 'â¬œ', 'è¿›è¡Œä¸­': 'ğŸ”„', 'å·²å®Œæˆ': 'âœ…' };
            let taskTable = '| ä»»åŠ¡ | æˆå‘˜ | çŠ¶æ€ |\n|------|------|------|';
            for (const t of tasks.sort((a, b) => a.number - b.number)) {
              const labels = t.labels.map(l => l.name);
              let status = 'â¬œ å¾…é¢†';
              if (labels.includes('å·²å®Œæˆ')) status = 'âœ… å·²å®Œæˆ';
              else if (labels.includes('è¿›è¡Œä¸­')) status = 'ğŸ”„ è¿›è¡Œä¸­';
              const assignee = t.assignees.length > 0
                ? t.assignees.map(a => a.login).join(', ')
                : '-';
              taskTable += `\n| #${t.number} ${t.title.replace(/\[TASK\]\s*/, '')} | ${assignee} | ${status} |`;
            }

            // Replace tables in content
            const statsRegex = /(### æˆå‘˜ç»Ÿè®¡\s*\n)[\s\S]*?(?=\n### ä»»åŠ¡å‚ä¸æƒ…å†µ)/;
            const taskRegex = /(### ä»»åŠ¡å‚ä¸æƒ…å†µ\s*\n)[\s\S]*?(?=\n---)/;

            if (content.match(statsRegex)) {
              content = content.replace(statsRegex, `### æˆå‘˜ç»Ÿè®¡\n\n${memberTable}\n\n`);
            }
            if (content.match(taskRegex)) {
              content = content.replace(taskRegex, `### ä»»åŠ¡å‚ä¸æƒ…å†µ\n\n${taskTable}\n`);
            }

            // Write back
            fs.writeFileSync('data/people.md', content, 'utf8');

      - name: Commit if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/people.md
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "[åŒæ­¥] è‡ªåŠ¨æ›´æ–°æˆå‘˜ç»Ÿè®¡å’Œä»»åŠ¡å‚ä¸æƒ…å†µ"
          git push
