name: Auto Add Member

on:
  issues:
    types: [labeled]

jobs:
  add-member:
    if: github.event.label.name == 'approved' && contains(github.event.issue.labels.*.name, '申请加入')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Issue and Create PR
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body;

            // Parse form fields from issue body
            function parseField(body, label) {
              // GitHub forms render as: ### Label\n\nValue\n\n
              const regex = new RegExp(`### ${label.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\s*\\n\\n([\\s\\S]*?)(?=\\n\\n###|$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            const name = parseField(body, '昵称/名字');
            const ghUser = parseField(body, 'GitHub 用户名');
            const skills = parseField(body, '技能标签');
            const time = parseField(body, '每周时间承诺');

            if (!name) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '❌ 无法提取昵称/名字，请检查 Issue 格式。'
              });
              return;
            }

            const today = new Date().toISOString().split('T')[0];
            const entry = `\n### ${name}\n- **GitHub**：${ghUser || '-'}\n- **加入时间**：${today}\n- **技能标签**：${skills}\n- **时间承诺**：每周 ${time}\n- **当前任务**：-\n- **历史贡献**：-\n`;

            // Create branch
            const branchName = `member/add-${name.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fff]/g, '-')}`;
            const mainRef = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });

            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: mainRef.data.object.sha
              });
            } catch (e) {
              // Branch might exist, update it
              await github.rest.git.updateRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branchName}`,
                sha: mainRef.data.object.sha,
                force: true
              });
            }

            // Get current people.md
            const file = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'data/people.md',
              ref: branchName
            });

            const currentContent = Buffer.from(file.data.content, 'base64').toString('utf8');
            // Insert before "## 如何加入" section (under "## 现有成员")
            const marker = '\n---\n\n## 如何加入';
            let newContent;
            if (currentContent.includes(marker)) {
              newContent = currentContent.replace(marker, '\n' + entry + marker);
            } else {
              // Fallback: append to end
              newContent = currentContent.trimEnd() + '\n' + entry;
            }

            // Update file on branch
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'data/people.md',
              message: `[成员] 添加 ${name} 到人才库`,
              content: Buffer.from(newContent).toString('base64'),
              sha: file.data.sha,
              branch: branchName
            });

            // Create PR
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[成员] 添加 ${name} 到人才库`,
              head: branchName,
              base: 'main',
              body: `## 变更类型\n- [x] 人才库变更\n\n## 变更内容\n自动添加新成员 **${name}** 到人才库。\n\n## 变更原因\n来自申请 Issue #${issue.number}，已通过审核。\n\n---\n*此 PR 由 GitHub Action 自动创建*`
            });

            // Comment on issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `✅ 已自动创建 PR #${pr.data.number}，合并后即完成入库。`
            });
