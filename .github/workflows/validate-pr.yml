name: Validate PR

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PR Title Prefix
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$TITLE" =~ ^\[成员\]|^\[资源\]|^\[任务\]|^\[其他\] ]]; then
            echo "❌ PR 标题必须包含前缀：[成员]、[资源]、[任务] 或 [其他]"
            echo "示例：[成员] 添加张三到人才库"
            exit 1
          fi
          echo "✅ PR 标题前缀正确"

      - name: Check PR Template
        run: |
          BODY="${{ github.event.pull_request.body }}"
          if [[ -z "$BODY" ]] || [[ "$BODY" == *"<!--"* ]]; then
            echo "❌ 必须填写 PR 描述模板"
            exit 1
          fi
          if ! echo "$BODY" | grep -q "## 变更类型"; then
            echo "❌ PR 描述必须包含：变更类型"
            exit 1
          fi
          if ! echo "$BODY" | grep -q "## 变更内容"; then
            echo "❌ PR 描述必须包含：变更内容"
            exit 1
          fi
          if ! echo "$BODY" | grep -q "## 变更原因"; then
            echo "❌ PR 描述必须包含：变更原因"
            exit 1
          fi
          echo "✅ PR 模板填写完整"

      - name: Validate files
        run: python3 validate_files.py

      - name: Comment on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ PR 验证失败\n\n请检查上述错误信息并修复后重新提交。`
            })
