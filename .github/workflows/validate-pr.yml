name: Validate PR

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check PR Title Prefix
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$TITLE" =~ ^\[成员\]|^\[资源\]|^\[任务\]|^\[其他\] ]]; then
            echo "❌ PR 标题必须包含前缀：[成员]、[资源]、[任务] 或 [其他]"
            echo "示例：[成员] 添加张三到人才库"
            exit 1
          fi
          echo "✅ PR 标题前缀正确"

      - name: Check PR Template
        run: |
          BODY="${{ github.event.pull_request.body }}"
          if [[ -z "$BODY" ]] || [[ "$BODY" == *"<!--"* ]]; then
            echo "❌ 必须填写 PR 描述模板"
            exit 1
          fi
          if [[ ! "$BODY" =~ ## 变更类型 ]] || [[ ! "$BODY" =~ ## 变更内容 ]] || [[ ! "$BODY" =~ ## 变更原因 ]]; then
            echo "❌ PR 描述必须包含：变更类型、变更内容、变更原因"
            exit 1
          fi
          echo "✅ PR 模板填写完整"

      - name: Validate data/people.md
        run: |
          python3 -c "import re,sys;content=open('data/people.md').read();sys.exit(1) if '# 人才库' not in content else None"
          python3 -c "import re,sys;content=open('data/people.md').read();sys.exit(1) if '## 现有成员' not in content else None"
          python3 -c "import re,sys;members=re.findall(r'### (.+)',open('data/people.md').read());sys.exit(1) if not members else None"
          python3 -c "import re;members=re.findall(r'### (.+)',open('data/people.md').read());[print(f'❌ {m} 缺少必要字段') if not re.search(rf'### {m}.*?- \*\*加入时间\*\*：.*?- \*\*技能标签\*\*：.*?- \*\*时间承诺\*\*：.*?- \*\*当前任务\*\*：.*?- \*\*历史贡献\*\*：',open('data/people.md').read(),re.DOTALL) for m in members];print('✅ people.md 格式正确')"

      - name: Validate data/resources.md
        run: |
          python3 -c "import re,sys;content=open('data/resources.md').read();sys.exit(1) if '# 资源池' not in content else None"
          python3 -c "import re,sys;content=open('data/resources.md').read();sys.exit(1) if '## 资源列表' not in content else None"
          python3 -c "import re,sys;resources=re.findall(r'### (.+)',open('data/resources.md').read());sys.exit(1) if not resources else None"
          python3 -c "import re;resources=re.findall(r'### (.+)',open('data/resources.md').read());[print(f'❌ {r} 缺少必要字段') if not re.search(rf'### {r}.*?- \*\*类型\*\*：.*?- \*\*描述\*\*：.*?- \*\*当前状态\*\*：.*?- \*\*负责人\*\*：',open('data/resources.md').read(),re.DOTALL) for r in resources];print('✅ resources.md 格式正确')"

      - name: Comment on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ PR 验证失败\n\n请检查上述错误信息并修复后重新提交。`
            })
